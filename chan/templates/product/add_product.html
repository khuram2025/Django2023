{% extends 'home/base.html' %}
{% load static %}
{% block content %}

<body id="body-item-post" class="item-publish">
  {% include 'home/header.html' %}

  <div class="container">
    <div class="box">
      <h1>Post your ad</h1>
      <form name="item" action="{% url 'product:add_product' %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Main Category Field -->
        <div class="form-section">
          <label for="id_category">{{ form.category.label }}</label>
          {{ form.category }}
        </div>

        <!-- Subcategory Field -->
        <div class="form-section" id="subcategory-section" style="display: none;">
          <label for="id_subcategory">Subcategory</label>
          <select id="id_subcategory" name="subcategory" class="form-control">
            <option value="">Select subcategory</option>
            <!-- Options will be populated based on the main category selection -->
          </select>
        </div>


        <!-- City Field -->
        <div class="form-section">
          <label for="id_city">{{ form.city.label }}</label>
          {{ form.city }}
        </div>


        <!-- Address Field -->
        <div class="form-section">
          <label for="id_address">{{ form.address.label }}</label>
          {{ form.address }}
        </div>

        <!-- Price Field -->
        <div class="form-section">
          <label for="id_price">{{ form.price.label }}</label>
          {{ form.price }}
        </div>

        <!-- Condition Field -->
        
        <div class="form-section">
          <label for="id_condition">{{ form.condition.label }}</label>
          {{ form.condition }}
        </div>
      

        <!-- Title Field -->
        <div class="form-section">
          <label for="id_title">{{ form.title.label }}</label>
          {{ form.title }}
        </div>

        <!-- Description Field -->
        <div class="form-section">
          <label for="id_description">{{ form.description.label }}</label>
          {{ form.description }}
        </div>

        <!-- YouTube Video URL Field -->
        <div class="form-section">
          <label for="id_youtube_video_url">{{ form.youtube_video_url.label }}</label>
          {{ form.youtube_video_url }}
        </div>

        <!-- Facebook Video URL Field -->
        <div class="form-section">
          <label for="id_facebook_video_url">{{ form.facebook_video_url.label }}</label>
          {{ form.facebook_video_url }}
        </div>

        <!-- Web Link Field -->
        <div class="form-section">
          <label for="id_web_link">{{ form.web_link.label }}</label>
          {{ form.web_link }}
        </div>

        <!-- Rest of your form fields go here -->



        <!-- Seller Information Fields -->
        <div class="form-section">
          <label for="id_phone_number">Contact Name</label>
          {{ form.contact_name }}

        </div>
        <div class="form-section">
          <label for="id_phone_number">Phone Number</label>
          {{ form.phone_number }}
          <label for="id_phone_visible" class="checkbox-label">
            {{ form.phone_visible }} Phone visible on ad
          </label>
        </div>

        <div class="form-section">
          <label for="id_email">Email</label>
          {{ form.email }}
          <label for="id_email_visible" class="checkbox-label">
            {{ form.email_visible }} Email visible on ad
          </label>
        </div>
        
        <div  id="custom-fields-container" class="form-section">
          <h2>Additional Information</h2>
          {% for field in form.custom_fields %}
              <div class="id="custom-fields-container" form-group">
                  <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                  {{ field }}
                  {% if field.help_text %}
                      <small class="form-text text-muted">{{ field.help_text }}</small>
                  {% endif %}
                  {% for error in field.errors %}
                      <div class="alert alert-danger">{{ error }}</div>
                  {% endfor %}
              </div>
          {% endfor %}
      </div>

        <!-- Formset for images -->
        <div class="form-section">
          <div class="image-upload-instructions">
            You can upload up to 15 pictures
          </div>
          <div class="image-upload-box">
            <label for="id_images">
              <i class="fa fa-camera" aria-hidden="true"></i> <!-- Use your preferred icon library -->
              <span>Click or Drop for Upload Image</span>
              <input type="file" name="images" multiple id="id_images" class="form-control">
            </label>
          </div>
          <!-- Image preview container -->
          <div id="image-preview-container" class="image-preview-row">
            <!-- Previews will be inserted here -->
          </div>
        </div>


        <!-- Messages -->
        {% if messages %}
        <ul class="messages">
          {% for message in messages %}
          <li{% if message.tags %} class="{{ message.tags }}" {% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
        {% endif %}

        <!-- Submit button -->
        <button type="submit" class="btn">Submit</button>
      </form>
    </div>
  </div>

  {% include 'home/footer.html' %}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script type="text/javascript">
    $(document).ready(function () {
      // Function to read and preview image
      function readURL(input) {
        if (input.files) {
          var container = $("#image-preview-container");
          // container.empty(); // Don't clear existing previews if you want to keep them

          $.each(input.files, function (index, file) {
            var reader = new FileReader();
            reader.onload = function (e) {
              // Create an image element for preview
              var img = $('<img>', {
                src: e.target.result,
                class: 'image-preview',
                alt: 'Image preview',
                style: 'max-width: 100px; max-height: 100px; margin: 10px;' // Adjust the size as necessary
              });
              container.append(img); // Append new images without clearing existing ones
            }
            reader.readAsDataURL(file);
          });
        }
      }

      // Initialize previews for already selected files
      readURL($('#id_images')[0]);

      // Listen for changes in the image input
      $('#id_images').on('change', function () {
        readURL(this);
      });
    });
  </script>


  <script type="text/javascript">
    $(document).ready(function () {
      function updateSubcategoryOptions() {
        var mainCategory = $('#id_category').val();
        $('#id_subcategory').empty().append('<option value="">Select subcategory</option>');
        if (mainCategory) {
          $.getJSON('{% url 'product:ajax_load_subcategories' %}', {category_id: mainCategory},
            function (data) {
              $.each(data, function (index, item) {
                $('#id_subcategory').append($('<option>', {
                  value: item.id,
                  text: item.title
                }));
              });
              $('#subcategory-section').show(); // Show subcategory section only if main category is selected
            });

        } else {
          $('#subcategory-section').hide(); // Hide the subcategory section if no main category is selected
        }
      }

      $('#id_category').change(updateSubcategoryOptions);
      // No need to run on document ready if you want it to only show when a category is selected
    });
    
  </script>
  <script>
  // The rest of your code...

$('#id_category').change(function () {
  var categoryId = $(this).val();
  loadCustomFields(categoryId);
  // No need to call updateSubcategoryOptions() here if it's already called inside loadCustomFields()
});

function loadCustomFields(categoryId) {
  if (!categoryId) {
      $('#custom-fields-container').empty();
      return;
  }
  $.getJSON('{% url 'product:ajax_load_custom_fields' %}', {category_id: categoryId}, function (data) {
      $('#custom-fields-container').empty();
      $.each(data.custom_fields, function (index, field) {
          // You'll need to adjust this part based on the actual data returned from your view
          // Create form elements based on field type
          // For example, if field.type is 'text':
          var input = $('<input>', {
              type: 'text', // Use field.field_type to determine the correct type
              class: 'form-control',
              name: 'custom_field_' + field.id,
              id: 'id_custom_field_' + field.id,
              placeholder: field.name // Use field.name or another property for the placeholder
          });
          var label = $('<label>', {
              for: 'id_custom_field_' + field.id,
              text: field.name // Use field.name or another property for the label
          });
          var div = $('<div>', {class: 'form-group'}).append(label).append(input);
          $('#custom-fields-container').append(div);
      });
  });
}

  </script>



</body>

{% endblock %}